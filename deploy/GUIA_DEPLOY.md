# üöÄ Guia Completo de Deploy - Arena BRB

## Dom√≠nio: arena.viegas.me | www.arena.viegas.me

---

## üìã √çndice

1. [Pr√©-requisitos](#pr√©-requisitos)
2. [Instala√ß√£o Inicial](#instala√ß√£o-inicial)
3. [Deploy Manual](#deploy-manual)
4. [Deploy Automatizado](#deploy-automatizado)
5. [Configura√ß√£o SSL/HTTPS](#configura√ß√£o-sslhttps)
6. [Manuten√ß√£o](#manuten√ß√£o)
7. [Troubleshooting](#troubleshooting)
8. [Comandos √öteis](#comandos-√∫teis)

---

## üéØ Pr√©-requisitos

### No Servidor Ubuntu

- Ubuntu Server 20.04 LTS ou superior
- Acesso SSH como root ou sudo
- M√≠nimo 1GB RAM
- M√≠nimo 10GB disco

### DNS Configurado

Certifique-se que os dom√≠nios apontam para o IP do servidor:

```
A     arena.viegas.me      ‚Üí  SEU_IP_SERVIDOR
A     www.arena.viegas.me  ‚Üí  SEU_IP_SERVIDOR
```

Verifique com:
```bash
dig arena.viegas.me +short
dig www.arena.viegas.me +short
```

### Acesso ao Reposit√≥rio

- URL do reposit√≥rio Git
- Credenciais de acesso (se privado)
- Google Maps API Key

---

## üöÄ Instala√ß√£o Inicial

### Op√ß√£o 1: Instala√ß√£o Autom√°tica (Recomendado)

1. **Conectar no servidor via SSH**
```bash
ssh usuario@seu-servidor-ip
```

2. **Fazer upload dos scripts de deploy**
```bash
# Na sua m√°quina local, dentro do projeto
scp -r deploy/ usuario@seu-servidor-ip:~/
```

3. **No servidor, executar o script de instala√ß√£o**
```bash
cd ~/deploy
chmod +x install.sh
sudo bash install.sh
```

4. **Seguir as instru√ß√µes do instalador**
   - Confirmar URL do reposit√≥rio
   - Informar se √© reposit√≥rio privado
   - Digitar Google Maps API Key
   - Configurar SSL (se DNS j√° estiver apontando)

5. **Pronto! O site estar√° no ar** üéâ

---

### Op√ß√£o 2: Instala√ß√£o Manual

#### Passo 1: Atualizar o Sistema

```bash
sudo apt update && sudo apt upgrade -y
```

#### Passo 2: Instalar Node.js 20 LTS

```bash
curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
sudo apt install -y nodejs

# Verificar instala√ß√£o
node --version  # deve mostrar v20.x.x
npm --version
```

#### Passo 3: Instalar Nginx

```bash
sudo apt install -y nginx
sudo systemctl enable nginx
sudo systemctl start nginx
```

#### Passo 4: Configurar Firewall

```bash
sudo ufw allow 'Nginx Full'
sudo ufw allow OpenSSH
sudo ufw enable
```

#### Passo 5: Clonar o Reposit√≥rio

```bash
cd /var/www
sudo git clone https://github.com/seu-usuario/MVP_ArenaBRB_Sprint.git arena-brb
sudo chown -R $USER:$USER /var/www/arena-brb
cd arena-brb
```

#### Passo 6: Configurar Vari√°veis de Ambiente

```bash
nano .env
```

Adicionar:
```
VITE_GOOGLE_MAPS_API_KEY="sua_chave_aqui"
```

#### Passo 7: Instalar Depend√™ncias e Build

```bash
npm install
npm run build
```

#### Passo 8: Configurar Nginx

```bash
sudo cp deploy/nginx.conf /etc/nginx/sites-available/arena-brb
sudo ln -s /etc/nginx/sites-available/arena-brb /etc/nginx/sites-enabled/
sudo rm /etc/nginx/sites-enabled/default
sudo nginx -t
sudo systemctl reload nginx
```

#### Passo 9: Ajustar Permiss√µes

```bash
sudo chown -R www-data:www-data /var/www/arena-brb/dist
```

---

## üîí Configura√ß√£o SSL/HTTPS

### Instalar Certbot

```bash
sudo apt install -y certbot python3-certbot-nginx
```

### Obter Certificado SSL

```bash
sudo certbot --nginx -d arena.viegas.me -d www.arena.viegas.me
```

Siga as instru√ß√µes:
1. Digite seu e-mail
2. Aceite os termos de servi√ßo
3. Escolha se quer compartilhar e-mail (opcional)

### Testar Renova√ß√£o Autom√°tica

```bash
sudo certbot renew --dry-run
```

O Certbot ir√° renovar automaticamente o certificado antes de expirar (90 dias).

### Verificar Status do Certificado

```bash
sudo certbot certificates
```

---

## üì¶ Deploy Manual

### Passo a Passo

```bash
# 1. Conectar no servidor
ssh usuario@seu-servidor

# 2. Navegar para o diret√≥rio
cd /var/www/arena-brb

# 3. Fazer backup do .env (importante!)
cp .env .env.backup

# 4. Atualizar c√≥digo
git pull origin main

# 5. Restaurar .env
cp .env.backup .env

# 6. Instalar depend√™ncias
npm install

# 7. Fazer build
npm run build

# 8. Ajustar permiss√µes
sudo chown -R www-data:www-data dist/

# 9. Recarregar Nginx
sudo nginx -t
sudo systemctl reload nginx
```

---

## ‚ö° Deploy Automatizado

### Usando o Script de Deploy

```bash
# Op√ß√£o 1: Comando r√°pido
deploy-arena

# Op√ß√£o 2: Script direto
cd /var/www/arena-brb
./deploy/deploy.sh
```

### O que o Script Faz

‚úÖ Faz backup do arquivo `.env`  
‚úÖ Atualiza o c√≥digo do Git  
‚úÖ Restaura o `.env`  
‚úÖ Instala depend√™ncias  
‚úÖ Faz build da aplica√ß√£o  
‚úÖ Ajusta permiss√µes  
‚úÖ Testa configura√ß√£o do Nginx  
‚úÖ Recarrega o Nginx  
‚úÖ Mostra logs e status  

---

## üîß Manuten√ß√£o

### Ver Logs do Nginx

```bash
# Logs de acesso
sudo tail -f /var/log/nginx/arena-brb-access.log

# Logs de erro
sudo tail -f /var/log/nginx/arena-brb-error.log

# √öltimas 50 linhas
sudo tail -n 50 /var/log/nginx/arena-brb-error.log
```

### Reiniciar Servi√ßos

```bash
# Recarregar Nginx (sem downtime)
sudo systemctl reload nginx

# Reiniciar Nginx (com downtime breve)
sudo systemctl restart nginx

# Ver status do Nginx
sudo systemctl status nginx
```

### Verificar Espa√ßo em Disco

```bash
df -h
du -sh /var/www/arena-brb
```

### Limpar Cache e Arquivos Antigos

```bash
cd /var/www/arena-brb
npm cache clean --force
rm -rf node_modules
npm install
```

### Backup

```bash
# Backup completo da aplica√ß√£o
cd /var/www
sudo tar -czf arena-brb-backup-$(date +%Y%m%d).tar.gz arena-brb/

# Backup apenas do c√≥digo fonte (sem node_modules)
cd /var/www/arena-brb
tar --exclude='node_modules' --exclude='dist' -czf ~/arena-brb-src-$(date +%Y%m%d).tar.gz .
```

### Restaurar Backup

```bash
cd /var/www
sudo tar -xzf arena-brb-backup-20240115.tar.gz
sudo systemctl reload nginx
```

---

## üîç Troubleshooting

### Problema: Site n√£o carrega (502 Bad Gateway)

**Causa**: Nginx n√£o consegue servir os arquivos

**Solu√ß√£o**:
```bash
# Verificar se o build existe
ls -la /var/www/arena-brb/dist

# Se n√£o existir, fazer build
cd /var/www/arena-brb
npm run build

# Verificar permiss√µes
sudo chown -R www-data:www-data /var/www/arena-brb/dist

# Recarregar Nginx
sudo systemctl reload nginx
```

---

### Problema: P√°gina em branco

**Causa**: Erro no JavaScript ou vari√°vel de ambiente faltando

**Solu√ß√£o**:
```bash
# Verificar se .env existe
cat /var/www/arena-brb/.env

# Verificar console do navegador (F12)
# Procurar por erros de API Key ou recursos n√£o carregados

# Refazer build
cd /var/www/arena-brb
npm run build
sudo systemctl reload nginx
```

---

### Problema: Rotas n√£o funcionam (404)

**Causa**: Configura√ß√£o do Nginx n√£o est√° com `try_files` correto

**Solu√ß√£o**:
```bash
# Verificar configura√ß√£o
sudo nano /etc/nginx/sites-available/arena-brb

# Deve ter esta linha:
# try_files $uri $uri/ /index.html;

# Testar e recarregar
sudo nginx -t
sudo systemctl reload nginx
```

---

### Problema: SSL n√£o renova automaticamente

**Causa**: Certbot timer n√£o est√° ativo

**Solu√ß√£o**:
```bash
# Verificar status do timer
sudo systemctl status certbot.timer

# Ativar se desabilitado
sudo systemctl enable certbot.timer
sudo systemctl start certbot.timer

# Testar renova√ß√£o
sudo certbot renew --dry-run
```

---

### Problema: Erro de permiss√µes

**Causa**: Arquivos com permiss√µes incorretas

**Solu√ß√£o**:
```bash
# Ajustar permiss√µes do c√≥digo
cd /var/www
sudo chown -R $USER:$USER arena-brb

# Ajustar permiss√µes do build
sudo chown -R www-data:www-data arena-brb/dist

# Garantir que o usu√°rio pode escrever logs
sudo chown -R www-data:www-data /var/log/nginx
```

---

### Problema: Git pull falha

**Causa**: Altera√ß√µes locais conflitando com o reposit√≥rio

**Solu√ß√£o**:
```bash
cd /var/www/arena-brb

# Ver status
git status

# Descartar altera√ß√µes locais (cuidado!)
git reset --hard origin/main

# Ou fazer stash das mudan√ßas
git stash
git pull origin main
```

---

### Problema: Build falha

**Causa**: Depend√™ncias desatualizadas ou conflitantes

**Solu√ß√£o**:
```bash
cd /var/www/arena-brb

# Limpar cache
npm cache clean --force

# Remover node_modules
rm -rf node_modules package-lock.json

# Reinstalar
npm install

# Tentar build novamente
npm run build
```

---

### Problema: Site lento

**Causa**: Cache n√£o configurado ou compress√£o desabilitada

**Solu√ß√£o**:
```bash
# Verificar se configura√ß√£o do Nginx tem gzip
sudo nano /etc/nginx/sites-available/arena-brb

# Deve ter:
# gzip on;
# gzip_types text/plain text/css application/json application/javascript;

# Recarregar
sudo systemctl reload nginx

# Verificar resposta com curl
curl -I https://arena.viegas.me
# Deve ter: Content-Encoding: gzip
```

---

## üìù Comandos √öteis

### Sistema

```bash
# Ver uso de CPU e mem√≥ria
htop

# Ver processos do Nginx
ps aux | grep nginx

# Ver portas em uso
sudo netstat -tulpn | grep LISTEN

# Ver logs do sistema
sudo journalctl -xe
```

### Nginx

```bash
# Testar configura√ß√£o
sudo nginx -t

# Recarregar configura√ß√£o
sudo systemctl reload nginx

# Reiniciar Nginx
sudo systemctl restart nginx

# Ver status
sudo systemctl status nginx

# Ver todas as configura√ß√µes de sites
ls -la /etc/nginx/sites-enabled/
```

### Git

```bash
# Ver branch atual
git branch

# Ver √∫ltimos commits
git log --oneline -5

# Ver mudan√ßas n√£o commitadas
git status

# Ver diferen√ßas
git diff

# Atualizar
git pull origin main
```

### Node/NPM

```bash
# Ver vers√£o
node --version
npm --version

# Listar pacotes instalados
npm list --depth=0

# Verificar por atualiza√ß√µes
npm outdated

# Limpar cache
npm cache clean --force
```

### Certificados SSL

```bash
# Listar certificados
sudo certbot certificates

# Renovar manualmente
sudo certbot renew

# Revogar certificado
sudo certbot revoke --cert-path /etc/letsencrypt/live/arena.viegas.me/cert.pem

# Deletar certificado
sudo certbot delete --cert-name arena.viegas.me
```

---

## üîê Seguran√ßa

### Checklist de Seguran√ßa

- [ ] Firewall (UFW) ativo e configurado
- [ ] SSL/HTTPS configurado e funcionando
- [ ] Renova√ß√£o autom√°tica de SSL ativa
- [ ] Apenas portas necess√°rias abertas (22, 80, 443)
- [ ] Chaves de API n√£o expostas no c√≥digo
- [ ] `.env` n√£o commitado no Git
- [ ] Headers de seguran√ßa configurados no Nginx
- [ ] Backup regular configurado
- [ ] Sistema atualizado regularmente

### Headers de Seguran√ßa

Os seguintes headers j√° est√£o configurados no `nginx.conf`:

```nginx
X-Frame-Options: SAMEORIGIN
X-Content-Type-Options: nosniff
X-XSS-Protection: 1; mode=block
Referrer-Policy: strict-origin-when-cross-origin
```

### Verificar Seguran√ßa

```bash
# Testar headers de seguran√ßa
curl -I https://arena.viegas.me

# Verificar SSL
openssl s_client -connect arena.viegas.me:443 -servername arena.viegas.me

# Verificar firewall
sudo ufw status verbose
```

---

## üìä Monitoramento

### Logs em Tempo Real

```bash
# Todos os acessos
sudo tail -f /var/log/nginx/arena-brb-access.log

# Apenas erros
sudo tail -f /var/log/nginx/arena-brb-error.log

# Ambos
sudo tail -f /var/log/nginx/arena-brb-*.log
```

### Estat√≠sticas de Acesso

```bash
# N√∫mero total de requisi√ß√µes hoje
grep "$(date +%d/%b/%Y)" /var/log/nginx/arena-brb-access.log | wc -l

# IPs √∫nicos
awk '{print $1}' /var/log/nginx/arena-brb-access.log | sort -u | wc -l

# Top 10 p√°ginas mais acessadas
awk '{print $7}' /var/log/nginx/arena-brb-access.log | sort | uniq -c | sort -rn | head -10

# Erros mais comuns
grep "error" /var/log/nginx/arena-brb-error.log | cut -d' ' -f9- | sort | uniq -c | sort -rn
```

---

## üéØ Checklist de Deploy

### Antes do Deploy

- [ ] C√≥digo testado localmente
- [ ] Build funcionando sem erros
- [ ] Vari√°veis de ambiente verificadas
- [ ] Backup do servidor atual feito
- [ ] DNS apontando corretamente

### Durante o Deploy

- [ ] C√≥digo atualizado do Git
- [ ] Depend√™ncias instaladas
- [ ] Build executado com sucesso
- [ ] Configura√ß√£o do Nginx testada
- [ ] Nginx recarregado

### Ap√≥s o Deploy

- [ ] Site acess√≠vel via HTTP/HTTPS
- [ ] Todas as p√°ginas carregando
- [ ] Rotas funcionando corretamente
- [ ] Google Maps carregando
- [ ] Console sem erros cr√≠ticos
- [ ] Logs do Nginx sem erros

---

## üÜò Suporte

### Contatos

- **Reposit√≥rio**: [GitHub]
- **Documenta√ß√£o**: Este arquivo

### Links √öteis

- [Documenta√ß√£o Nginx](https://nginx.org/en/docs/)
- [Certbot](https://certbot.eff.org/)
- [Vite Documentation](https://vitejs.dev/)
- [React Documentation](https://react.dev/)

---

## üìÑ Estrutura de Arquivos

```
/var/www/arena-brb/
‚îú‚îÄ‚îÄ deploy/
‚îÇ   ‚îú‚îÄ‚îÄ deploy.sh          # Script de deploy
‚îÇ   ‚îú‚îÄ‚îÄ install.sh         # Script de instala√ß√£o
‚îÇ   ‚îú‚îÄ‚îÄ nginx.conf         # Configura√ß√£o Nginx
‚îÇ   ‚îî‚îÄ‚îÄ GUIA_DEPLOY.md     # Este arquivo
‚îú‚îÄ‚îÄ dist/                  # Build da aplica√ß√£o (gerado)
‚îú‚îÄ‚îÄ node_modules/          # Depend√™ncias (gerado)
‚îú‚îÄ‚îÄ public/                # Assets p√∫blicos
‚îú‚îÄ‚îÄ src/                   # C√≥digo fonte
‚îú‚îÄ‚îÄ .env                   # Vari√°veis de ambiente (criar)
‚îú‚îÄ‚îÄ package.json
‚îú‚îÄ‚îÄ vite.config.ts
‚îî‚îÄ‚îÄ README.md

/etc/nginx/
‚îú‚îÄ‚îÄ sites-available/
‚îÇ   ‚îî‚îÄ‚îÄ arena-brb          # Config do site
‚îî‚îÄ‚îÄ sites-enabled/
    ‚îî‚îÄ‚îÄ arena-brb          # Link simb√≥lico

/var/log/nginx/
‚îú‚îÄ‚îÄ arena-brb-access.log   # Logs de acesso
‚îî‚îÄ‚îÄ arena-brb-error.log    # Logs de erro
```

---

## üéâ Pronto!

Seu site Arena BRB est√° no ar em:

- üåê https://arena.viegas.me
- üåê https://www.arena.viegas.me

Para fazer deploy novamente, basta executar:
```bash
deploy-arena
```

**Bom trabalho! üöÄ**